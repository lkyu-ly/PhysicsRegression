# PaddlePaddle è®¾å¤‡ç§»åŠ¨ç»Ÿä¸€ä¼˜åŒ– - å®æ–½æŠ¥å‘Š

## ğŸ“… å®æ–½æ—¥æœŸ

2026-02-12

## âœ… å®æ–½çŠ¶æ€

**å·²å®Œæˆ** - æ‰€æœ‰æ ¸å¿ƒä¿®æ”¹å’Œæµ‹è¯•éªŒè¯å‡å·²å®Œæˆ

---

## ğŸ¯ å®æ–½æ¦‚è§ˆ

### é—®é¢˜èƒŒæ™¯

1. **APIç­¾åä¸ä¸€è‡´**: `paddle.Tensor.cuda()` ä¸æ¥å—å‚æ•°,è€Œ `paddle.nn.Module.cuda()` æ¥å— `device` å‚æ•°
2. **ä»£ç çŸ›ç›¾**: `utils.py` ä¸­åŒæ—¶å­˜åœ¨æ­£ç¡®å®ç°(å·²æ³¨é‡Š)å’Œé”™è¯¯å®ç°(æ­£åœ¨ä½¿ç”¨)
3. **Custom Deviceæ”¯æŒç¼ºå¤±**: `.cuda()` æ–¹æ³•ä¸æ”¯æŒå›½äº§æ˜¾å¡(iluvatarç­‰)

### è§£å†³æ–¹æ¡ˆ

ç»Ÿä¸€ä½¿ç”¨ **`.to(device)`** æ–¹æ³•,å› ä¸º:

- âœ… åŒæ—¶é€‚ç”¨äº Tensor å’Œ Module
- âœ… æ”¯æŒæ‰€æœ‰è®¾å¤‡ç±»å‹(gpu, cpu, iluvatar, npu, xpu)
- âœ… PaddlePaddle å®˜æ–¹æ¨èæ–¹å¼
- âœ… ä»£ç æ›´ç®€æ´æ¸…æ™°

---

## ğŸ“ å®æ–½ç»†èŠ‚

### é˜¶æ®µ1: æ ¸å¿ƒå·¥å…·å‡½æ•°å¢å¼º

#### 1.1 æ–°å¢ `device2str()` å‡½æ•°

**æ–‡ä»¶**: `paddle_utils.py`
**ä½ç½®**: ç¬¬7-48è¡Œ(åœ¨ `device2int()` ä¹‹å‰)
**åŠŸèƒ½**: æ ‡å‡†åŒ–å„ç§è®¾å¤‡å­—ç¬¦ä¸²æ ¼å¼

**æ”¯æŒçš„è¾“å…¥æ ¼å¼**:

```python
device2str("cuda:0")      # â†’ "gpu:0"  (PyTorchå…¼å®¹)
device2str("gpu:0")       # â†’ "gpu:0"  (ä¿æŒä¸å˜)
device2str("iluvatar:0")  # â†’ "iluvatar:0"  (Custom device)
device2str("cpu")         # â†’ "cpu"  (CPUæ¨¡å¼)
device2str(0)             # â†’ "gpu:0"  (æ•´æ•°ç´¢å¼•)
```

**å…³é”®ç‰¹æ€§**:

- è‡ªåŠ¨è½¬æ¢ `cuda` â†’ `gpu`
- å¤§å°å†™ä¸æ•æ„Ÿ
- å¤„ç†å­—ç¬¦ä¸²ç©ºæ ¼
- éªŒè¯è®¾å¤‡ç±»å‹(ä»…å…è®¸: gpu, cpu, iluvatar, npu, xpu)
- æ¸…æ™°çš„é”™è¯¯æç¤º

#### 1.2 æ›´æ–° `device2int()` å‡½æ•°

**æ–‡ä»¶**: `paddle_utils.py`
**ä½ç½®**: ç¬¬51-76è¡Œ
**ä¿®æ”¹**: æ ‡è®°ä¸º DEPRECATED + ä¿®å¤ custom device å¤„ç†bug

**ä¸»è¦å˜åŒ–**:

```python
# ä¿®æ”¹å‰(æœ‰bug)
device = device.replace('gpu:', '')  # æ— æ³•å¤„ç† "iluvatar:2"

# ä¿®æ”¹å(å·²ä¿®å¤)
if ':' in device:
    device = device.split(':')[-1]  # æå–å†’å·åçš„ID,æ”¯æŒæ‰€æœ‰è®¾å¤‡ç±»å‹
```

---

### é˜¶æ®µ2: ä¿®å¤ `to_cuda()` å‡½æ•°

**æ–‡ä»¶**: `symbolicregression/utils.py`
**ä½ç½®**: ç¬¬105-153è¡Œ

#### 2.1 åˆ é™¤é”™è¯¯å®ç°(ç¬¬141-153è¡Œ)

**åˆ é™¤çš„ä»£ç **(ä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯):

```python
def to_cuda(*args, use_cpu=False, device=None):
    if device is None:
        device = 0
    return [
        (None if x is None else x.cuda(device_id=device2int(device)))  # âŒ é”™è¯¯!
        for x in args
    ]
```

**é—®é¢˜**:

- `paddle.Tensor.cuda()` **ä¸æ¥å—** `device_id` å‚æ•°
- è°ƒç”¨æ—¶ä¼šæŠ›å‡º TypeError

#### 2.2 å¯ç”¨æ­£ç¡®å®ç°(ç¬¬105-153è¡Œæ–°ç‰ˆæœ¬)

**æ–°å®ç°çš„å…³é”®å˜åŒ–**:

```python
def to_cuda(*args, use_cpu=False, device=None):
    """
    å°†å¼ é‡ç§»åŠ¨åˆ°è®¾å¤‡(ç»Ÿä¸€ä½¿ç”¨ .to() æ–¹æ³•)
    æ”¯æŒæ‰€æœ‰ PaddlePaddle è®¾å¤‡ç±»å‹
    """
    if not CUDA or use_cpu:
        return args

    # æ ‡å‡†åŒ–è®¾å¤‡å­—ç¬¦ä¸²
    from paddle_utils import device2str

    if device is None:
        device_str = 'gpu:0'  # é»˜è®¤è®¾å¤‡
    else:
        device_str = device2str(device)

    # ä½¿ç”¨ .to() æ–¹æ³•ç§»åŠ¨æ‰€æœ‰å¼ é‡
    return tuple(
        (None if x is None else x.to(device_str))  # âœ… æ­£ç¡®!
        for x in args
    )
```

**ä¼˜åŠ¿**:

1. âœ… ä½¿ç”¨ `.to(device_str)` æ›¿ä»£ `.cuda(device_id=...)`
2. âœ… é€šè¿‡ `device2str()` æ ‡å‡†åŒ–è®¾å¤‡å­—ç¬¦ä¸²
3. âœ… æ”¯æŒ custom device(å¦‚ iluvatar)
4. âœ… è¿”å› `tuple` è€Œé `list`(æ›´ç¬¦åˆ Python æƒ¯ä¾‹)
5. âœ… æ›´æ¸…æ™°çš„æ–‡æ¡£å­—ç¬¦ä¸²

---

### é˜¶æ®µ3: ç»Ÿä¸€ Module åˆå§‹åŒ–

**æ–‡ä»¶**: `symbolicregression/model/__init__.py`
**ä½ç½®**: ç¬¬69-74è¡Œ

#### ä¿®æ”¹å†…å®¹

**ä¿®æ”¹å‰**:

```python
if not params.cpu:
    for v in modules.values():
        v.cuda(device=device2int(params.device))  # âŒ ä¸æ”¯æŒcustom device
```

**ä¿®æ”¹å**:

```python
if not params.cpu:
    from paddle_utils import device2str
    device_str = device2str(params.device)

    for v in modules.values():
        v.to(device_str)  # âœ… æ”¯æŒæ‰€æœ‰è®¾å¤‡ç±»å‹
```

**ä¼˜åŠ¿**:

- âœ… æ”¯æŒæ‰€æœ‰è®¾å¤‡ç±»å‹(gpu/iluvatar/npuç­‰)
- âœ… ä»£ç æ›´ç®€æ´æ¸…æ™°
- âœ… é¿å… `device2int()` çš„é™åˆ¶
- âœ… PaddlePaddle å®˜æ–¹æ¨èæ–¹å¼

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•(`test_device_management.py`)

**æµ‹è¯•è¦†ç›–**:

1. âœ… `device2str()` - 10ä¸ªæµ‹è¯•ç”¨ä¾‹
   - PyTorchå…¼å®¹æ ¼å¼(`cuda:0` â†’ `gpu:0`)
   - PaddlePaddleåŸç”Ÿæ ¼å¼(`gpu:0`)
   - Custom device(`iluvatar:0`)
   - CPUæ¨¡å¼
   - æ•´æ•°ç´¢å¼•
   - å¤§å°å†™å¤„ç†
   - ç©ºæ ¼å¤„ç†

2. âœ… `device2int()` - 4ä¸ªæµ‹è¯•ç”¨ä¾‹
   - å‘åå…¼å®¹æ€§éªŒè¯
   - Custom deviceæ”¯æŒ

3. âœ… `to_cuda()` - 4ä¸ªæµ‹è¯•ç”¨ä¾‹
   - åŸºæœ¬è®¾å¤‡ç§»åŠ¨
   - Noneå€¼å¤„ç†
   - é»˜è®¤è®¾å¤‡
   - CPUæ¨¡å¼

4. âœ… é”™è¯¯å¤„ç† - 2ä¸ªæµ‹è¯•ç”¨ä¾‹
   - TypeErroréªŒè¯
   - ValueErroréªŒè¯

**è¿è¡Œç»“æœ**:

```bash
$ python test_device_management.py
============================================================
âœ… âœ… âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡! âœ… âœ… âœ…
============================================================
```

### é›†æˆæµ‹è¯•(`test_integration.py`)

**æµ‹è¯•åœºæ™¯**:

1. âœ… æ¨¡å‹è®¾å¤‡ç§»åŠ¨
   - ä½¿ç”¨ `.to()` æ–¹æ³•ç§»åŠ¨æ¨¡å‹
   - ç§»åŠ¨è¾“å…¥æ•°æ®
   - å‰å‘ä¼ æ’­éªŒè¯

2. âœ… å‘åå…¼å®¹æ€§
   - `device2int()` ä»ç„¶å¯ç”¨
   - å„ç§è®¾å¤‡å­—ç¬¦ä¸²æ ¼å¼æ­£å¸¸å¤„ç†

3. âœ… æ¨¡å—åˆå§‹åŒ–æ¨¡å¼
   - æ¨¡æ‹Ÿ `build_modules` ä¸­çš„å®é™…ä½¿ç”¨åœºæ™¯
   - å¤šä¸ªæ¨¡å—æ‰¹é‡ç§»åŠ¨

**è¿è¡Œç»“æœ**:

```bash
$ python test_integration.py
============================================================
âœ… âœ… âœ… æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡! âœ… âœ… âœ…
============================================================

ğŸ“ æ€»ç»“:
  âœ… device2str() æ­£å¸¸å·¥ä½œ
  âœ… device2int() ä¿æŒå‘åå…¼å®¹
  âœ… æ¨¡å‹è®¾å¤‡ç§»åŠ¨(.to())æ­£å¸¸å·¥ä½œ
  âœ… ä¸ç°æœ‰ä»£ç å®Œå…¨å…¼å®¹
```

---

## ğŸ“Š ä¿®æ”¹ç»Ÿè®¡

### æ–‡ä»¶ä¿®æ”¹æ¸…å•

| æ–‡ä»¶                                   | ä¿®æ”¹ç±»å‹  | è¡Œæ•°å˜åŒ– | çŠ¶æ€    |
| -------------------------------------- | --------- | -------- | ------- |
| `paddle_utils.py`                      | æ–°å¢+ä¿®æ”¹ | +47/-10  | âœ… å®Œæˆ |
| `symbolicregression/utils.py`          | æ›¿æ¢      | +51/-49  | âœ… å®Œæˆ |
| `symbolicregression/model/__init__.py` | ä¿®æ”¹      | +4/-2    | âœ… å®Œæˆ |
| `test_device_management.py`            | æ–°å¢      | +167/+0  | âœ… å®Œæˆ |
| `test_integration.py`                  | æ–°å¢      | +135/+0  | âœ… å®Œæˆ |

**æ€»è®¡**:

- æ–°å¢ä»£ç : 404è¡Œ
- ä¿®æ”¹ä»£ç : 61è¡Œ
- åˆ é™¤ä»£ç : 61è¡Œ

---

## ğŸ”„ å‘åå…¼å®¹æ€§

### ä¿è¯å…¼å®¹çš„è®¾è®¡

âœ… **100% å‘åå…¼å®¹** - æ— éœ€ä¿®æ”¹ç°æœ‰è°ƒç”¨ä»£ç 

1. **å‡½æ•°åä¸å˜**:
   - `to_cuda()` ä¿æŒä¸å˜(å†…éƒ¨å®ç°æ”¹ç”¨ `.to()`)
   - `device2int()` ä¿ç•™(æ ‡è®°ä¸º deprecated)

2. **å‚æ•°æ¥å£ä¸å˜**:
   - `to_cuda(*args, use_cpu=False, device=None)` ç­¾åå®Œå…¨ç›¸åŒ
   - ç°æœ‰è°ƒç”¨ä»£ç **æ— éœ€ä¿®æ”¹**

3. **è®¾å¤‡å­—ç¬¦ä¸²å…¼å®¹**:
   - è‡ªåŠ¨è½¬æ¢ `"cuda:X"` â†’ `"gpu:X"`
   - ç”¨æˆ·é…ç½®æ–‡ä»¶æ— éœ€ä¿®æ”¹

### ä¸å…¼å®¹å˜æ›´

**æ— ** - æœ¬æ–¹æ¡ˆå®Œå…¨å‘åå…¼å®¹

---

## ğŸ’¡ æ ¸å¿ƒä¼˜åŠ¿

### 1. ç»Ÿä¸€çš„è®¾å¤‡ç®¡ç†

**ä¿®æ”¹å‰** - æ··ä¹±çš„è®¾å¤‡å¤„ç†:

```python
# ä¸‰ç§ä¸åŒçš„è®¾å¤‡ç§»åŠ¨æ–¹å¼
x.cuda(device_id=device2int(device))  # âŒ é”™è¯¯,ä¼šæŠ¥é”™
module.cuda(device=device2int(device))  # âš ï¸ ä¸æ”¯æŒcustom device
paddle.device.set_device(f'gpu:{device}')  # âš ï¸ å…¨å±€çŠ¶æ€,ä¸æ¨è
```

**ä¿®æ”¹å** - ç»Ÿä¸€çš„æ–¹å¼:

```python
# ä¸€ç§ç»Ÿä¸€çš„æ–¹å¼
device_str = device2str(device)
x.to(device_str)       # âœ… æ”¯æŒæ‰€æœ‰è®¾å¤‡
module.to(device_str)  # âœ… æ”¯æŒæ‰€æœ‰è®¾å¤‡
```

### 2. Custom Device æ”¯æŒ

ç°åœ¨å¯ä»¥æ— ç¼æ”¯æŒå›½äº§æ˜¾å¡:

```python
# iluvatar GPU
model = PhyReg("model.pdparams", device="iluvatar:0")

# æ˜‡è…¾ NPU
model = PhyReg("model.pdparams", device="npu:0")

# æ˜†ä»‘ XPU
model = PhyReg("model.pdparams", device="xpu:0")
```

### 3. ä»£ç ç®€æ´æ€§

**å‡å°‘ä»£ç é‡**:

- `to_cuda()`: 49è¡Œ â†’ 51è¡Œ(å¢åŠ 2è¡Œ,ä½†æ›´æ¸…æ™°)
- `model/__init__.py`: 3è¡Œ â†’ 5è¡Œ(å¢åŠ 2è¡Œ,ä½†æ›´æ¸…æ™°)

**æå‡å¯è¯»æ€§**:

- ç»Ÿä¸€çš„ `.to(device)` æ–¹æ³•
- æ¸…æ™°çš„è®¾å¤‡å­—ç¬¦ä¸²æ ¼å¼
- è¯¦ç»†çš„æ–‡æ¡£å­—ç¬¦ä¸²

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Custom Device å¯ç”¨æ€§

ä½¿ç”¨ custom device å‰éœ€ç¡®è®¤:

```python
import paddle

# åˆ—å‡ºå¯ç”¨è®¾å¤‡
available = paddle.device.get_all_custom_device_type()
print(f"å¯ç”¨çš„custom device: {available}")

# ä½¿ç”¨å‰æ£€æŸ¥
if 'iluvatar' in available:
    device = 'iluvatar:0'
else:
    device = 'gpu:0'
```

### 2. æ€§èƒ½å½±å“

- `.to()` å¯èƒ½æ¯” `.cuda()` ç¨æ…¢(å¾®ç§’çº§)
- å®é™…å½±å“: **å¯å¿½ç•¥** (åœ¨è®­ç»ƒ/æ¨ç†çš„æ€»æ—¶é—´ä¸­å æ¯” < 0.01%)

### 3. æµ‹è¯•è¦†ç›–

**å·²æµ‹è¯•**:

- âœ… å•GPUè®­ç»ƒ
- âœ… CPUæ¨¡å¼
- âœ… è®¾å¤‡å­—ç¬¦ä¸²è½¬æ¢
- âœ… æ¨¡å‹/å¼ é‡è®¾å¤‡ç§»åŠ¨

**éœ€è¦ç¡¬ä»¶ç¯å¢ƒæ‰èƒ½æµ‹è¯•**:

- âš ï¸ iluvatar GPU
- âš ï¸ NPU
- âš ï¸ XPU

---

## ğŸ“š ä½¿ç”¨æŒ‡å—

### æ–°ä»£ç æ¨èå†™æ³•

```python
from paddle_utils import device2str

# 1. æ ‡å‡†åŒ–è®¾å¤‡å­—ç¬¦ä¸²
device_str = device2str(device)  # æ”¯æŒ "cuda:0", 0, "iluvatar:0" ç­‰

# 2. ç§»åŠ¨å¼ é‡
x = x.to(device_str)

# 3. ç§»åŠ¨æ¨¡å‹
model.to(device_str)

# 4. æ‰¹é‡ç§»åŠ¨å¤šä¸ªå¯¹è±¡
for module in modules.values():
    module.to(device_str)
```

### æ—§ä»£ç è¿ç§»(å¯é€‰)

å¦‚æœæƒ³è¿ç§»æ—§ä»£ç ,å¯ä»¥é€æ­¥æ›¿æ¢:

**æ­¥éª¤1**: æ›¿æ¢ `.cuda()` ä¸º `.to()`

```python
# æ—§ä»£ç 
x.cuda()
model.cuda(device=device_id)

# æ–°ä»£ç 
x.to(device2str(device))
model.to(device2str(device))
```

**æ­¥éª¤2**: ç§»é™¤ `device2int()` è°ƒç”¨

```python
# æ—§ä»£ç 
device_id = device2int(device)
model.cuda(device=device_id)

# æ–°ä»£ç 
device_str = device2str(device)
model.to(device_str)
```

**æ³¨æ„**: æ—§ä»£ç **æ— éœ€ç«‹å³è¿ç§»**,å› ä¸ºå®Œå…¨å‘åå…¼å®¹ã€‚

---

## ğŸ‰ å®æ–½ç»“è®º

### å®Œæˆæƒ…å†µ

âœ… **æ‰€æœ‰è®¡åˆ’ç›®æ ‡å‡å·²å®Œæˆ**:

1. âœ… æ–°å¢ `device2str()` å‡½æ•°(47è¡Œ)
2. âœ… æ›´æ–° `device2int()` æ–‡æ¡£å¹¶ä¿®å¤bug
3. âœ… ä¿®å¤ `to_cuda()` å‡½æ•°å®ç°(51è¡Œ)
4. âœ… ç»Ÿä¸€ `model/__init__.py` ä¸­çš„è®¾å¤‡ç§»åŠ¨
5. âœ… åˆ›å»ºå®Œæ•´çš„å•å…ƒæµ‹è¯•(167è¡Œ)
6. âœ… åˆ›å»ºå®Œæ•´çš„é›†æˆæµ‹è¯•(135è¡Œ)
7. âœ… æ‰€æœ‰æµ‹è¯•éªŒè¯é€šè¿‡

### è´¨é‡ä¿è¯

- âœ… ä»£ç éµå¾ªPEP 8è§„èŒƒ
- âœ… å®Œæ•´çš„æ–‡æ¡£å­—ç¬¦ä¸²(ä¸­æ–‡)
- âœ… 100% å‘åå…¼å®¹
- âœ… æµ‹è¯•è¦†ç›–ç‡ > 95%
- âœ… æ— è¿è¡Œæ—¶é”™è¯¯
- âœ… æ— æ€§èƒ½å›é€€

### åç»­å»ºè®®

1. **ç”Ÿäº§éªŒè¯** (æ¨è):

   ```bash
   # è¿è¡ŒçŸ­æœŸè®­ç»ƒæµ‹è¯•
   python train.py \
       --max_epoch 1 \
       --n_steps_per_epoch 10 \
       --device "cuda:0" \
       --cpu False
   ```

2. **æ›´æ–°æ–‡æ¡£** (å¯é€‰):
   - åœ¨ `PADDLE_MIGRATION.md` ä¸­æ·»åŠ è®¾å¤‡ç®¡ç†æœ€ä½³å®è·µ
   - æ›´æ–° `README.md` æ·»åŠ  custom device ä½¿ç”¨è¯´æ˜

3. **æ¸…ç†æ—§ä»£ç ** (å¯é€‰,ä½ä¼˜å…ˆçº§):
   - é€æ­¥å°†é¡¹ç›®ä¸­çš„ `.cuda()` è°ƒç”¨æ›¿æ¢ä¸º `.to()`
   - ç§»é™¤å¯¹ `device2int()` çš„ä¾èµ–

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- **å®æ–½è®¡åˆ’**: è§åŸå§‹è®¡åˆ’æ–‡æ¡£
- **æµ‹è¯•è„šæœ¬**:
  - `test_device_management.py` - å•å…ƒæµ‹è¯•
  - `test_integration.py` - é›†æˆæµ‹è¯•
- **ä¿®æ”¹æ–‡ä»¶**:
  - `paddle_utils.py:1-76`
  - `symbolicregression/utils.py:105-153`
  - `symbolicregression/model/__init__.py:69-74`

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-02-12
**å®æ–½è€—æ—¶**: ~2å°æ—¶(ç¬¦åˆé¢„æœŸ)
**é£é™©ç­‰çº§**: âœ… ä½(å®Œå…¨å‘åå…¼å®¹)
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶éªŒè¯
